name: Deploy a blueprint

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  detect-changes:
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.get_changed.outputs.files }}
      has_changes: ${{ steps.get_changed.outputs.has_changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Get changed JSON files from PR
        id: get_changed
        run: |
          echo "PR merged: ${{ github.event.pull_request.merged }}"
          echo "PR base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "PR head SHA: ${{ github.event.pull_request.head.sha }}"

          # Get changed JSON files between base and head of PR
          CHANGED_FILES=$(git diff --name-only --diff-filter=AM \
            ${{ github.event.pull_request.base.sha }} \
            ${{ github.event.pull_request.head.sha }} -- '*.json' || true)

          echo "Changed JSON files:"
          echo "$CHANGED_FILES"

          # Convert to JSON array for matrix
          if [[ -n "$CHANGED_FILES" ]]; then
            FILES_JSON=$(echo "$CHANGED_FILES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "files=$FILES_JSON" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "files=[]" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  run-cli:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.detect-changes.outputs.changed_files) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run CLI command with file
        run: |
          echo "=========================================="
          echo "Processing file: ${{ matrix.file }}"
          echo "=========================================="
          
          # Display file contents
          echo "File contents:"
          cat "${{ matrix.file }}"
          
          # Extract values from JSON (example)
          VALUE=$(jq -r '.test' "${{ matrix.file }}" 2>/dev/null || echo "N/A")
          echo "Extracted value: $VALUE"
          
          # =============================================
          # Replace with your actual CLI command below
          # =============================================
          # Example: AWS SageMaker
          # aws sagemaker create-model --cli-input-json file://${{ matrix.file }}
          
          # Example: Custom CLI
          # my-cli deploy --config "${{ matrix.file }}"
          
          echo "CLI executed for: ${{ matrix.file }}"
          echo "the aws account: ${{ vars.AWS_ACCOUNT_ID }}"