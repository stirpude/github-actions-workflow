name: Deploy CDK capability

on:
  push:
    branches:
      - main
    paths:
      - 'cdk-scripts/**/config.json'

jobs:
  detect-config-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_config: ${{ steps.find_config.outputs.config }}
      config_filename: ${{ steps.find_config.outputs.config_filename }}
      has_changes: ${{ steps.find_config.outputs.has_changes }}
      folder_name: ${{ steps.find_config.outputs.folder_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Detect changed config.json files in cdk-scripts
        id: find_config
        run: |
          echo "=========================================="
          echo "Detecting config.json changes in cdk-scripts:"
          echo "=========================================="
          
          # Get all changed config.json files in cdk-scripts folder
          CHANGED_CONFIGS=$(git diff --name-only --diff-filter=AM \
            ${{ github.event.before }} \
            ${{ github.sha }} | grep '^cdk-scripts/.*/config\.json$' || true)
          
          echo "Changed config files:"
          echo "$CHANGED_CONFIGS"
          
          # Count changed files
          COUNT=$(echo "$CHANGED_CONFIGS" | grep -c 'config.json' || true)
          echo "Number of config files changed: $COUNT"
          
          if [ "$COUNT" -gt 1 ]; then
            echo "ERROR: Multiple config.json files changed. Only one file should be changed at a time."
            echo "Changed files:"
            echo "$CHANGED_CONFIGS"
            exit 1
          fi
          
          if [ -n "$CHANGED_CONFIGS" ]; then
            CONFIG_FILE=$(echo "$CHANGED_CONFIGS" | tr -d '\n')
            
            # Extract filename (e.g., 'config.json')
            CONFIG_FILENAME=$(basename "$CONFIG_FILE")
            
            # Extract subfolder name (e.g., 'sagemaker-domain' from 'cdk-scripts/sagemaker-domain/config.json')
            FOLDER_NAME=$(echo "$CONFIG_FILE" | cut -d'/' -f2)
            
            echo "config=$CONFIG_FILE" >> $GITHUB_OUTPUT
            echo "config_filename=$CONFIG_FILENAME" >> $GITHUB_OUTPUT
            echo "folder_name=$FOLDER_NAME" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            echo "=========================================="
            echo "Config file to deploy: $CONFIG_FILE"
            echo "Config filename: $CONFIG_FILENAME"
            echo "Subfolder: $FOLDER_NAME"
            echo "=========================================="
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No config.json changes detected in cdk-scripts"
          fi

  validate-config:
    needs: detect-config-changes
    if: needs.detect-config-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate config.json syntax
        run: |
          CONFIG_FILE="${{ needs.detect-config-changes.outputs.changed_config }}"
          CONFIG_FILENAME="${{ needs.detect-config-changes.outputs.config_filename }}"
          
          echo "Validating: $CONFIG_FILE"
          echo "Filename: $CONFIG_FILENAME"
          
          # Validate JSON syntax
          jq empty "$CONFIG_FILE" || {
            echo "ERROR: Invalid JSON in $CONFIG_FILE"
            exit 1
          }
          
          echo "✅ JSON validation passed"
          
          # Display config contents
          echo "=========================================="
          echo "Config contents:"
          echo "=========================================="
          cat "$CONFIG_FILE"

  deploy-capability:
    needs: [detect-config-changes, validate-config]
    if: needs.detect-config-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Extract deployment details
        id: extract_config
        run: |
          CONFIG_FILE="${{ needs.detect-config-changes.outputs.changed_config }}"
          CONFIG_FILENAME="${{ needs.detect-config-changes.outputs.config_filename }}"
          FOLDER_NAME="${{ needs.detect-config-changes.outputs.folder_name }}"
          
          # Extract full folder path
          FOLDER_PATH=$(dirname "$CONFIG_FILE")
          
          echo "folder_path=$FOLDER_PATH" >> $GITHUB_OUTPUT
          echo "folder_name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "config_filename=$CONFIG_FILENAME" >> $GITHUB_OUTPUT
          
          echo "=========================================="
          echo "Deployment Details:"
          echo "=========================================="
          echo "Config File: $CONFIG_FILE"
          echo "Config Filename: $CONFIG_FILENAME"
          echo "Subfolder: $FOLDER_NAME"
          echo "Full Path: $FOLDER_PATH"
          echo "=========================================="

      - name: Setup Node.js (for CDK)
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          FOLDER_PATH="${{ steps.extract_config.outputs.folder_path }}"
          
          echo "Installing dependencies in: $FOLDER_PATH"
          cd "$FOLDER_PATH"
          
          # Install CDK and dependencies
          npm install
          
          echo "Dependencies installed successfully"

      #- name: Configure AWS credentials
      #  uses: aws-actions/configure-aws-credentials@v2
      #  with:
      #    role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/GitHubActionsRole
      #    aws-region: ${{ vars.AWS_REGION }}

      #- name: Deploy CDK stack
      #  run: |
      #    FOLDER_PATH="${{ steps.extract_config.outputs.folder_path }}"
      #    FOLDER_NAME="${{ steps.extract_config.outputs.folder_name }}"
      #    CONFIG_FILENAME="${{ steps.extract_config.outputs.config_filename }}"
      #    CONFIG_FILE="${{ needs.detect-config-changes.outputs.changed_config }}"
          
      #    echo "=========================================="
      #    echo "Deploying CDK Stack: $FOLDER_NAME"
      #    echo "=========================================="
          
      #    # Navigate to subfolder
      #    cd "$FOLDER_PATH"
          
      #    echo "Current directory: $(pwd)"
      #    echo "Config filename: $CONFIG_FILENAME"
      #    echo "Full config path: $CONFIG_FILE"
          
      #    # Display config
      #    echo "Config contents:"
      #    cat "$CONFIG_FILENAME"
          
      #    # Extract stack name from config
      #    STACK_NAME=$(jq -r '.stackName' "$CONFIG_FILENAME")
      #    ENVIRONMENT=$(jq -r '.environment // "dev"' "$CONFIG_FILENAME")
          
      #    echo "Stack Name: $STACK_NAME"
      #    echo "Environment: $ENVIRONMENT"
          
      #    # Run CDK deploy with config filename as parameter
      #    echo "Running CDK deploy with config: $CONFIG_FILENAME"
      #    cdk deploy \
      #      --require-approval never \
      #      --config configFile=$CONFIG_FILENAME \
      #      --config stackName=$STACK_NAME \
      #      --config environment=$ENVIRONMENT
          
      #    if [ $? -eq 0 ]; then
      #      echo "✅ CDK deployment completed successfully"
      #      echo "Config file used: $CONFIG_FILENAME"
      #    else
      #      echo "❌ CDK deployment failed"
      #      exit 1
      #    fi

      - name: Run custom CLI command with config filename
        run: |
          FOLDER_PATH="${{ steps.extract_config.outputs.folder_path }}"
          CONFIG_FILENAME="${{ steps.extract_config.outputs.config_filename }}"
          FOLDER_NAME="${{ steps.extract_config.outputs.folder_name }}"
          
          cd "$FOLDER_PATH"
          
          echo "=========================================="
          echo "Running CLI with config filename parameter"
          echo "=========================================="
          echo "CLI Command: my-cli deploy --config $CONFIG_FILENAME"
          echo "Subfolder: $FOLDER_NAME"
          echo "=========================================="
          
          # Replace 'my-cli' with your actual CLI command
          # my-cli deploy --config "$CONFIG_FILENAME"
          # or
          # my-cli deploy --input "$CONFIG_FILENAME" --environment "prod"
          
          echo "✅ CLI command executed with config: $CONFIG_FILENAME"

  post-deployment:
    needs: [detect-config-changes, deploy-capability]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create deployment summary
        run: |
          CONFIG_FILE="${{ needs.detect-config-changes.outputs.changed_config }}"
          CONFIG_FILENAME="${{ needs.detect-config-changes.outputs.config_filename }}"
          FOLDER_NAME="${{ needs.detect-config-changes.outputs.folder_name }}"
          DEPLOY_STATUS="${{ needs.deploy-capability.result }}"
          
          echo "=========================================="
          echo "Deployment Summary"
          echo "=========================================="
          echo "Subfolder: $FOLDER_NAME"
          echo "Config File: $CONFIG_FILE"
          echo "Config Filename: $CONFIG_FILENAME"
          echo "Status: $DEPLOY_STATUS"
          echo "=========================================="

      - name: Notify on failure
        if: needs.deploy-capability.result == 'failure'
        run: |
          echo "❌ Deployment failed for ${{ needs.detect-config-changes.outputs.folder_name }}"
          echo "Config file: ${{ needs.detect-config-changes.outputs.config_filename }}"
          exit 1