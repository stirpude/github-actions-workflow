name: Bootstrap Deploy

on:
  push:
    branches:
      - fake-main
      - dev
    paths:
      - 'cdk-scripts/bootstrap/**/*.json'
  
jobs:
  detect-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect config file
        id: detect
        run: |
          # If manually triggered
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            CONFIG_FILE="bootstrap/${ENV}/config.json"
            
            if [ -f "$CONFIG_FILE" ]; then
              echo "config_file=$CONFIG_FILE" >> $GITHUB_OUTPUT
              echo "environment=$ENV" >> $GITHUB_OUTPUT
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "âœ… Manual trigger: Using $CONFIG_FILE"
            else
              echo "âŒ Config file not found: $CONFIG_FILE"
              echo "has_changes=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            # Auto-detect from push
            if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
              CHANGED_CONFIG=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD 2>/dev/null \
                | grep '^cdk-scripts/bootstrap/.*\.json$' \
                | head -1 || true)
              
              if [ -z "$CHANGED_CONFIG" ]; then
                CHANGED_CONFIG=$(git ls-files \
                  | grep '^cdk-scripts/bootstrap/.*\.json$' \
                  | head -1 || true)
              fi
            else
              CHANGED_CONFIG=$(git diff --name-only --diff-filter=AM \
                ${{ github.event.before }} \
                ${{ github.sha }} \
                | grep '^cdk-scripts/bootstrap/.*\.json$' \
                | head -1 || true)
            fi
            
            if [ -n "$CHANGED_CONFIG" ]; then
              # Extract environment from path (cdk-scripts/bootstrap/dev/config.json -> dev)
              ENV=$(echo "$CHANGED_CONFIG" | cut -d'/' -f2)
              
              echo "config_file=$CHANGED_CONFIG" >> $GITHUB_OUTPUT
              echo "environment=$ENV" >> $GITHUB_OUTPUT
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "âœ… Detected: $CHANGED_CONFIG (Environment: $ENV)"
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ No bootstrap config changes detected"
            fi
          fi

      - name: Validate JSON
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          CONFIG_FILE="${{ steps.detect.outputs.config_file }}"
          jq empty "$CONFIG_FILE" || { echo "âŒ Invalid JSON"; exit 1; }
          echo "âœ… JSON is valid"

      - name: Read config
        if: steps.detect.outputs.has_changes == 'true'
        id: config
        run: |
          CONFIG_FILE="${{ steps.detect.outputs.config_file }}"
          
          ACCOUNT=$(jq -r '.account' "$CONFIG_FILE")
          REGION=$(jq -r '.region // "us-east-1"' "$CONFIG_FILE")
          IAM_ROLE=$(jq -r '.iam_role' "$CONFIG_FILE")
          STACK_NAME=$(jq -r '.stack_name // "bootstrap"' "$CONFIG_FILE")
          ENVIRONMENT=$(jq -r '.environment' "$CONFIG_FILE")
          
          echo "account=$ACCOUNT" >> $GITHUB_OUTPUT
          echo "region=$REGION" >> $GITHUB_OUTPUT
          echo "iam_role=$IAM_ROLE" >> $GITHUB_OUTPUT
          echo "stack_name=$STACK_NAME" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          
          echo "=========================================="
          echo "Account: $ACCOUNT"
          echo "Region: $REGION"
          echo "IAM Role: $IAM_ROLE"
          echo "Stack Name: $STACK_NAME"
          echo "Environment: $ENVIRONMENT"
          echo "=========================================="

      - name: Validate environment and branch
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          ENV="${{ steps.detect.outputs.environment }}"
          BRANCH="${{ github.ref_name }}"
          EVENT="${{ github.event_name }}"
          
          echo "Environment: $ENV"
          echo "Branch: $BRANCH"
          echo "Event: $EVENT"
          
          # Block manual trigger for prod
          if [ "$EVENT" == "workflow_dispatch" ] && [ "$ENV" == "prod" ]; then
            echo "âŒ ERROR: Manual trigger not allowed for prod"
            exit 1
          fi
          
          # Prod can only deploy from fake-main branch via push
          if [ "$ENV" == "prod" ] && [ "$BRANCH" != "fake-main" ]; then
            echo "âŒ ERROR: Prod can only be deployed from fake-main branch"
            echo "Current branch: $BRANCH"
            exit 1
          fi
          
          # Dev can only deploy from dev branch (except manual trigger)
          if [ "$ENV" == "dev" ] && [ "$BRANCH" != "dev" ] && [ "$EVENT" != "workflow_dispatch" ]; then
            echo "âŒ ERROR: Dev config can only be deployed from dev branch"
            echo "Current branch: $BRANCH"
            exit 1
          fi
          
          echo "âœ… Validation passed"

      - name: Configure AWS credentials
        if: steps.detect.outputs.has_changes == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.config.outputs.iam_role }}
          aws-region: ${{ steps.config.outputs.region }}

      - name: Run Bootstrap CLI
        if: steps.detect.outputs.has_changes == 'true'
        run: |
          ACCOUNT="${{ steps.config.outputs.account }}"
          REGION="${{ steps.config.outputs.region }}"
          STACK_NAME="${{ steps.config.outputs.stack_name }}"
          ENVIRONMENT="${{ steps.config.outputs.environment }}"
          CONFIG_FILE="${{ steps.detect.outputs.config_file }}"
          
          echo "=========================================="
          echo "ðŸš€ Running Bootstrap CLI"
          echo "Environment: $ENVIRONMENT"
          echo "Account: $ACCOUNT"
          echo "Region: $REGION"
          echo "Config: $CONFIG_FILE"
          echo "=========================================="
          
          # Run CLI
          echo "cli deploy --config $CONFIG_FILE"
          
          # Uncomment for actual CLI:
          # cli deploy --config "$CONFIG_FILE"
          
          echo "=========================================="
          echo "âœ… Bootstrap complete"

      - name: Deployment summary
        if: always() && steps.detect.outputs.has_changes == 'true'
        run: |
          echo "## ðŸš€ Bootstrap Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ steps.detect.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Account** | ${{ steps.config.outputs.account }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ steps.config.outputs.region }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Config File** | ${{ steps.detect.outputs.config_file }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Trigger** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY