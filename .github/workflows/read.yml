name: Bootstrap Deploy

on:
  push:
    branches:
      - fake-main
      - dev
    paths:
      - 'bootstrap/**/*.json'

jobs:
  detect-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect config file and extract ENV
        id: detect
        run: |
          echo "=========================================="
          echo "Detecting config file and environment"
          echo "=========================================="
          
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "First commit or force push detected"
            CHANGED_CONFIG=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD 2>/dev/null \
              | grep '^bootstrap/.*\.json$' \
              | head -1 || true)
            
            if [ -z "$CHANGED_CONFIG" ]; then
              CHANGED_CONFIG=$(git ls-files \
                | grep '^bootstrap/.*\.json$' \
                | head -1 || true)
            fi
          else
            CHANGED_CONFIG=$(git diff --name-only --diff-filter=AM \
              ${{ github.event.before }} \
              ${{ github.sha }} \
              | grep '^bootstrap/.*\.json$' \
              | head -1 || true)
          fi
          
          echo "Changed config file: $CHANGED_CONFIG"
          
          if [ -n "$CHANGED_CONFIG" ]; then
            # Extract ENV from folder path
            # Example: bootstrap/dev/config.json -> dev
            # Example: bootstrap/prod/config.json -> prod
            ENV=$(echo "$CHANGED_CONFIG" | cut -d'/' -f2)
            
            echo "=========================================="
            echo "ENV Extraction:"
            echo "  Full path: $CHANGED_CONFIG"
            echo "  Extracted ENV: $ENV"
            echo "=========================================="
            
            echo "config_file=$CHANGED_CONFIG" >> $GITHUB_OUTPUT
            echo "environment=$ENV" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No bootstrap config changes detected"
          fi

      - name: Validate environment and branch match
        if: steps.detect.outputs.has_changes == 'true'
        id: validate
        run: |
          ENV="${{ steps.detect.outputs.environment }}"
          BRANCH="${{ github.ref_name }}"
          CONFIG_FILE="${{ steps.detect.outputs.config_file }}"
          
          echo "=========================================="
          echo "Validation Check"
          echo "=========================================="
          echo "Config File: $CONFIG_FILE"
          echo "Extracted ENV: $ENV"
          echo "Current Branch: $BRANCH"
          echo "=========================================="
          
          # RULE 1: bootstrap/dev/ â†’ only dev branch
          if [ "$ENV" == "dev" ] && [ "$BRANCH" != "dev" ]; then
            echo "âš ï¸ SKIP: bootstrap/dev/ can only deploy from dev branch"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # RULE 2: bootstrap/prod/ â†’ only fake-main branch
          if [ "$ENV" == "prod" ] && [ "$BRANCH" != "fake-main" ]; then
            echo "âš ï¸ SKIP: bootstrap/prod/ can only deploy from fake-main branch"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… Validation passed"
          echo "should_deploy=true" >> $GITHUB_OUTPUT

      - name: Validate JSON syntax
        if: steps.detect.outputs.has_changes == 'true' && steps.validate.outputs.should_deploy == 'true'
        run: |
          CONFIG_FILE="${{ steps.detect.outputs.config_file }}"
          jq empty "$CONFIG_FILE" || { echo "âŒ Invalid JSON"; exit 1; }
          echo "âœ… JSON is valid"

      - name: Read config parameters
        if: steps.detect.outputs.has_changes == 'true' && steps.validate.outputs.should_deploy == 'true'
        id: config
        run: |
          CONFIG_FILE="${{ steps.detect.outputs.config_file }}"
          
          ACCOUNT=$(jq -r '.account' "$CONFIG_FILE")
          REGION=$(jq -r '.region // "us-east-1"' "$CONFIG_FILE")
          IAM_ROLE=$(jq -r '.iam_role' "$CONFIG_FILE")
          STACK_NAME=$(jq -r '.stack_name // "bootstrap"' "$CONFIG_FILE")
          ENVIRONMENT=$(jq -r '.environment' "$CONFIG_FILE")
          
          echo "account=$ACCOUNT" >> $GITHUB_OUTPUT
          echo "region=$REGION" >> $GITHUB_OUTPUT
          echo "iam_role=$IAM_ROLE" >> $GITHUB_OUTPUT
          echo "stack_name=$STACK_NAME" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          
          echo "=========================================="
          echo "Account: $ACCOUNT"
          echo "Region: $REGION"
          echo "IAM Role: $IAM_ROLE"
          echo "Stack Name: $STACK_NAME"
          echo "Environment: $ENVIRONMENT"
          echo "=========================================="

      - name: Configure AWS credentials
        if: steps.detect.outputs.has_changes == 'true' && steps.validate.outputs.should_deploy == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.config.outputs.iam_role }}
          aws-region: ${{ steps.config.outputs.region }}

      - name: Run Bootstrap CLI
        if: steps.detect.outputs.has_changes == 'true' && steps.validate.outputs.should_deploy == 'true'
        run: |
          ACCOUNT="${{ steps.config.outputs.account }}"
          REGION="${{ steps.config.outputs.region }}"
          STACK_NAME="${{ steps.config.outputs.stack_name }}"
          ENVIRONMENT="${{ steps.config.outputs.environment }}"
          CONFIG_FILE="${{ steps.detect.outputs.config_file }}"
          
          echo "=========================================="
          echo "ðŸš€ Running Bootstrap CLI"
          echo "=========================================="
          echo "Environment: $ENVIRONMENT"
          echo "Account: $ACCOUNT"
          echo "Region: $REGION"
          echo "Config File: $CONFIG_FILE"
          echo "=========================================="
          
          # CLI Command
          echo "cli deploy --config $CONFIG_FILE"
          
          # Uncomment for actual CLI:
          # cli deploy --config "$CONFIG_FILE"
          
          echo "=========================================="
          echo "âœ… Bootstrap complete"

      - name: Deployment summary
        if: always() && steps.detect.outputs.has_changes == 'true'
        run: |
          SHOULD_DEPLOY="${{ steps.validate.outputs.should_deploy }}"
          ENV="${{ steps.detect.outputs.environment }}"
          BRANCH="${{ github.ref_name }}"
          
          echo "## ðŸš€ Bootstrap Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Config File** | ${{ steps.detect.outputs.config_file }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **ENV** | $ENV |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | $BRANCH |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deployed** | $SHOULD_DEPLOY |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$SHOULD_DEPLOY" == "true" ]; then
            echo "| **Account** | ${{ steps.config.outputs.account }} |" >> $GITHUB_STEP_SUMMARY
            echo "| **Region** | ${{ steps.config.outputs.region }} |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Deployment successful**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Skipped - ENV ($ENV) doesn't match Branch ($BRANCH)**" >> $GITHUB_STEP_SUMMARY
          fi